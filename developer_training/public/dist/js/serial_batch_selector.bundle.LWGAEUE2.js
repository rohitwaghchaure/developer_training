(()=>{erpnext.CustomSerialBatchPackageSelector=class{constructor(e,t,i){var a;debugger;this.frm=e,this.item=t,this.qty=t.qty,this.callback=i,this.bundle=(a=this.item)!=null&&a.is_rejected?this.item.rejected_serial_and_batch_bundle:this.item.serial_and_batch_bundle,this.make(),this.render_data()}make(){var a,s,_,l,o;let e=(a=this.item)!=null&&a.has_serial_no?__("Serial Nos"):__("Batch Nos"),t=this.bundle?__("Update"):__("Add");((s=this.item)==null?void 0:s.has_serial_no)&&((_=this.item)==null?void 0:_.batch_no)&&(e=__("Serial Nos / Batch Nos")),t+=" "+e,this.dialog=new frappe.ui.Dialog({title:((l=this.item)==null?void 0:l.title)||t,fields:this.get_dialog_fields(),primary_action_label:t,primary_action:()=>this.update_bundle_entries(),secondary_action_label:__("Edit Full Form"),secondary_action:()=>this.edit_full_form()}),this.dialog.show(),this.$scan_btn=this.dialog.$wrapper.find(".link-btn"),this.$scan_btn.css("display","inline");let i=this.item.stock_qty||this.item.transfer_qty||this.item.qty;(o=this.item)!=null&&o.is_rejected&&(i=this.item.rejected_qty),i=Math.abs(i),i>0&&this.dialog.set_value("qty",i).then(()=>{if(this.item.serial_no&&!this.item.serial_and_batch_bundle){let n=this.item.serial_no.split(`
`);n.length>1?n.forEach(d=>{this.dialog.fields_dict.entries.df.data.push({serial_no:d,batch_no:this.item.batch_no})}):this.dialog.set_value("scan_serial_no",this.item.serial_no),frappe.model.set_value(this.item.doctype,this.item.name,"serial_no","")}else this.item.batch_no&&!this.item.serial_and_batch_bundle&&(this.dialog.set_value("scan_batch_no",this.item.batch_no),frappe.model.set_value(this.item.doctype,this.item.name,"batch_no",""));this.dialog.fields_dict.entries.grid.refresh()})}get_serial_no_filters(){var t;let e=((t=this.item)==null?void 0:t.type_of_transaction)==="Outward"?this.item.warehouse||this.item.s_warehouse:"";return this.frm.doc.doctype==="Stock Entry"&&(e=this.item.s_warehouse||this.item.t_warehouse),!e&&this.frm.doc.doctype==="Stock Reconciliation"&&(e=this.get_warehouse()),{item_code:this.item.item_code,warehouse:["=",e]}}get_dialog_fields(){var t;let e=[];return e.push({fieldtype:"Link",fieldname:"warehouse",label:__("Warehouse"),options:"Warehouse",default:this.get_warehouse(),onchange:()=>{this.item.warehouse=this.dialog.get_value("warehouse"),this.get_auto_data()},get_query:()=>({filters:{is_group:0,company:this.frm.doc.company}})}),this.frm.doc.doctype==="Stock Entry"&&this.frm.doc.purpose==="Manufacture"&&(e.push({fieldtype:"Column Break"}),e.push({fieldtype:"Link",fieldname:"work_order",label:__("For Work Order"),options:"Work Order",read_only:1,default:this.frm.doc.work_order}),e.push({fieldtype:"Section Break"})),e.push({fieldtype:"Column Break"}),this.item.has_serial_no&&e.push({fieldtype:"Data",options:"Barcode",fieldname:"scan_serial_no",label:__("Scan Serial No"),get_query:()=>({filters:this.get_serial_no_filters()}),onchange:()=>this.scan_barcode_data()}),this.item.has_batch_no&&!this.item.has_serial_no&&e.push({fieldtype:"Data",options:"Barcode",fieldname:"scan_batch_no",label:__("Scan Batch No"),onchange:()=>this.scan_barcode_data()}),((t=this.item)==null?void 0:t.type_of_transaction)==="Outward"?e=[...this.get_filter_fields(),...e]:e=[...e,...this.get_attach_field()],e.push({fieldtype:"Section Break"}),e.push({fieldname:"entries",fieldtype:"Table",allow_bulk_edit:!0,data:[],fields:this.get_dialog_table_fields()}),e}get_attach_field(){var a,s,_,l;let e=(a=this.item)!=null&&a.has_serial_no?__("Serial Nos"):__("Batch Nos"),t=this.bundle?__("Update"):__("Add");((s=this.item)==null?void 0:s.has_serial_no)&&((_=this.item)==null?void 0:_.has_batch_no)&&(e=__("Serial Nos / Batch Nos"));let i=[{fieldtype:"Section Break",label:__("{0} {1} via CSV File",[t,e])}];return(l=this.item)!=null&&l.has_serial_no&&(i=[...i,{fieldtype:"Check",label:__("Import Using CSV file"),fieldname:"import_using_csv_file",default:0},{fieldtype:"Section Break",label:__("{0} {1} Manually",[t,e]),depends_on:"eval:doc.import_using_csv_file === 0"},{fieldtype:"Small Text",label:__("Enter Serial Nos"),fieldname:"upload_serial_nos",depends_on:"eval:doc.import_using_csv_file === 0",description:__("Enter each serial no in a new line")},{fieldtype:"Column Break",depends_on:"eval:doc.import_using_csv_file === 0"},{fieldtype:"Button",fieldname:"make_serial_nos",label:__("Create Serial Nos"),depends_on:"eval:doc.import_using_csv_file === 0",click:()=>{this.create_serial_nos()}},{fieldtype:"Section Break",depends_on:"eval:doc.import_using_csv_file === 1"}]),i=[...i,{fieldtype:"Button",fieldname:"download_csv",label:__("Download CSV Template"),click:()=>this.download_csv_file()},{fieldtype:"Column Break"},{fieldtype:"Attach",fieldname:"attach_serial_batch_csv",label:__("Attach CSV File"),onchange:()=>this.upload_csv_file()}],i}create_serial_nos(){let{upload_serial_nos:e}=this.dialog.get_values();e||frappe.throw(__("Please enter Serial Nos")),frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.create_serial_nos",args:{item_code:this.item.item_code,serial_nos:e},callback:t=>{t.message&&(this.dialog.fields_dict.entries.df.data=[],this.set_data(t.message),this.update_bundle_entries())}})}download_csv_file(){let e=["Serial No"];this.item.has_serial_no&&this.item.has_batch_no?e=["Serial No","Batch No","Quantity"]:this.item.has_batch_no&&(e=["Batch No","Quantity"]);let t=`/api/method/erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.download_blank_csv_template?content=${encodeURIComponent(JSON.stringify(e))}`;window.open(frappe.urllib.get_full_url(t))||frappe.msgprint(__("Please enable pop-ups"))}upload_csv_file(){let e=this.dialog.get_value("attach_serial_batch_csv");frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.upload_csv_file",args:{item_code:this.item.item_code,file_path:e},callback:t=>{t.message.serial_nos&&t.message.serial_nos.length?this.set_data(t.message.serial_nos):t.message.batch_nos&&t.message.batch_nos.length&&this.set_data(t.message.batch_nos)}})}get_filter_fields(){return[{fieldtype:"Section Break",label:__("Auto Fetch")},{fieldtype:"Float",fieldname:"qty",label:__("Qty to Fetch"),onchange:()=>this.get_auto_data()},{fieldtype:"Column Break"},{fieldtype:"Select",options:["FIFO","LIFO","Expiry"],default:"FIFO",fieldname:"based_on",label:__("Fetch Based On"),onchange:()=>this.get_auto_data()},{fieldtype:"Section Break"}]}get_dialog_table_fields(){let e=[];this.item.has_serial_no&&e.push({fieldtype:"Link",options:"Serial No",fieldname:"serial_no",label:__("Serial No"),in_list_view:1,get_query:()=>({filters:this.get_serial_no_filters()})});let t=[];return this.item.has_batch_no&&(t=[{fieldtype:"Link",options:"Batch",fieldname:"batch_no",label:__("Batch No"),in_list_view:1,get_query:()=>{let i=!1;return(["Purchase Receipt","Purchase Invoice"].includes(this.frm.doc.doctype)&&!this.frm.doc.is_return||this.frm.doc.doctype==="Stock Entry"&&this.frm.doc.purpose==="Material Receipt")&&(i=!0),{query:"erpnext.controllers.queries.get_batch_no",filters:{item_code:this.item.item_code,warehouse:this.item.s_warehouse||this.item.t_warehouse||this.item.warehouse,is_inward:i}}}}],this.item.has_serial_no||t.push({fieldtype:"Float",fieldname:"qty",label:__("Quantity"),in_list_view:1})),e=[...e,...t],e.push({fieldtype:"Data",fieldname:"name",label:__("Name"),hidden:1}),e}get_auto_data(){let{qty:e,based_on:t}=this.dialog.get_values();(this.item.serial_and_batch_bundle||this.item.rejected_serial_and_batch_bundle)&&e===this.qty||this.item.serial_no||this.item.batch_no||(t||(t="FIFO"),e&&frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.get_auto_data",args:{item_code:this.item.item_code,warehouse:this.item.warehouse||this.item.s_warehouse,has_serial_no:this.item.has_serial_no,has_batch_no:this.item.has_batch_no,qty:e,based_on:t},callback:i=>{i.message&&(this.dialog.fields_dict.entries.df.data=i.message,this.dialog.fields_dict.entries.grid.refresh())}}))}scan_barcode_data(){let{scan_serial_no:e,scan_batch_no:t}=this.dialog.get_values();(e||t)&&frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.is_serial_batch_no_exists",args:{item_code:this.item.item_code,type_of_transaction:this.item.type_of_transaction,serial_no:e,batch_no:t},callback:i=>{this.update_serial_batch_no()}})}update_serial_batch_no(){let{scan_serial_no:e,scan_batch_no:t}=this.dialog.get_values();if(e){let i=this.dialog.fields_dict.entries.df.data.filter(a=>{if(a.serial_no===e)return a});i!=null&&i.length&&frappe.throw(__("Serial No {0} already exists",[e])),this.item.has_batch_no?frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.get_batch_no_from_serial_no",args:{serial_no:e},callback:a=>{a.message&&(this.dialog.fields_dict.entries.df.data.push({serial_no:e,batch_no:a.message}),this.dialog.fields_dict.scan_serial_no.set_value(""))}}):(this.dialog.fields_dict.entries.df.data.push({serial_no:e}),this.dialog.fields_dict.scan_serial_no.set_value(""))}else if(t){let i=this.dialog.fields_dict.entries.df.data.filter(a=>{if(a.batch_no===t)return a});i!=null&&i.length?i[0].qty+=1:this.dialog.fields_dict.entries.df.data.push({batch_no:t,qty:1}),this.dialog.fields_dict.scan_batch_no.set_value("")}this.dialog.fields_dict.entries.grid.refresh()}update_bundle_entries(){let e=this.dialog.get_values().entries,t=this.dialog.get_value("warehouse");(e&&!e.length||!e)&&frappe.throw(__("Please add atleast one Serial No / Batch No")),frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.add_serial_batch_ledgers",args:{entries:e,child_row:this.item,doc:this.frm.doc,warehouse:t}}).then(i=>{this.callback&&this.callback(i.message),this.frm.save(),this.dialog.hide()})}edit_full_form(){let e=this.item.serial_and_batch_bundle;if(!e){let t=frappe.model.get_new_doc("Serial and Batch Bundle",null,null,!0);t.item_code=this.item.item_code,t.warehouse=this.get_warehouse(),t.has_serial_no=this.item.has_serial_no,t.has_batch_no=this.item.has_batch_no,t.type_of_transaction=this.item.type_of_transaction,t.company=this.frm.doc.company,t.voucher_type=this.frm.doc.doctype,e=t.name}frappe.set_route("Form","Serial and Batch Bundle",e),this.dialog.hide()}get_warehouse(){var e;return((e=this.item)==null?void 0:e.type_of_transaction)==="Outward"?this.item.warehouse||this.item.s_warehouse:this.item.warehouse||this.item.t_warehouse}render_data(){this.bundle&&frappe.call({method:"erpnext.stock.doctype.serial_and_batch_bundle.serial_and_batch_bundle.get_serial_batch_ledgers",args:{item_code:this.item.item_code,name:this.bundle,voucher_no:this.frm.is_new()?"":this.item.parent}}).then(e=>{e.message&&this.set_data(e.message)})}set_data(e){e.forEach(t=>{t.qty=Math.abs(t.qty),this.dialog.fields_dict.entries.df.data.push(t)}),this.dialog.fields_dict.entries.grid.refresh()}};})();
//# sourceMappingURL=serial_batch_selector.bundle.LWGAEUE2.js.map
